# Task Runner ä»£ç ç»“æ„æ–‡æ¡£

## ğŸ“‹ ç›®å½•
- [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
- [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
- [æ ¸å¿ƒæ¨¡å—](#æ ¸å¿ƒæ¨¡å—)
- [ç›®å½•ç»“æ„](#ç›®å½•ç»“æ„)
- [ä¸»è¦åŠŸèƒ½æµç¨‹](#ä¸»è¦åŠŸèƒ½æµç¨‹)
- [ä¾èµ–å…³ç³»](#ä¾èµ–å…³ç³»)

## é¡¹ç›®æ¦‚è¿°

**é¡¹ç›®åç§°**: Task Runner  
**ç‰ˆæœ¬**: 0.2.0  
**è¯­è¨€**: Rust (Edition 2021)  
**ç±»å‹**: AIé©±åŠ¨çš„ä»»åŠ¡æ‰§è¡ŒæœåŠ¡  
**è®¸å¯è¯**: MIT

Task Runner æ˜¯ä¸€ä¸ªAIåŸç”Ÿçš„ä»£ç åŠ©æ‰‹æœåŠ¡ï¼Œæ”¯æŒé€šè¿‡å‘½ä»¤è¡Œå·¥å…·å’ŒHTTP REST APIä¸¤ç§æ–¹å¼ä½¿ç”¨ã€‚å®ƒèƒ½å¤Ÿç†è§£è‡ªç„¶è¯­è¨€ä»»åŠ¡æè¿°ï¼Œè‡ªä¸»è§„åˆ’å¹¶æ‰§è¡Œä»»åŠ¡ã€‚

## æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·æ¥å£å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  CLI (main)  â”‚              â”‚  HTTP Server â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚         â”‚                              â”‚                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â”‚        æ ¸å¿ƒæœåŠ¡å±‚            â”‚                    â”‚
â”‚         â–¼                              â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  CodeAgent   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   Service    â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚         â”‚                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â”‚           AIå¼•æ“å±‚                                â”‚
â”‚         â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ Understandingâ”‚         â”‚  Execution   â”‚                â”‚
â”‚  â”‚   Engine     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Engine     â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚         â”‚                        â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â”‚      åŸºç¡€è®¾æ–½å±‚        â”‚                         â”‚
â”‚         â–¼                        â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ Language     â”‚         â”‚    Tools     â”‚                â”‚
â”‚  â”‚   Models     â”‚         â”‚   Registry   â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚  â€¢ OpenAI                 â€¢ ReadFile                       â”‚
â”‚  â€¢ Anthropic              â€¢ WriteFile                      â”‚
â”‚  â€¢ Zhipu GLM              â€¢ RunCommand                     â”‚
â”‚  â€¢ Local Models           â€¢ ListFiles                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒæ¨¡å—

### 1. **main.rs** - ç¨‹åºå…¥å£
**è·¯å¾„**: `src/main.rs`  
**åŠŸèƒ½**: åº”ç”¨ç¨‹åºçš„ä¸»å…¥å£ç‚¹

**ä¸»è¦åŠŸèƒ½**:
- åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ (tracing)
- è§£æå‘½ä»¤è¡Œå‚æ•°
- è°ƒç”¨CLIæ¨¡å—æ‰§è¡Œå‘½ä»¤
- é”™è¯¯å¤„ç†å’Œé€€å‡º

**å…³é”®ä»£ç **:
```rust
#[tokio::main]
async fn main() -> anyhow::Result<()> {
    tracing_subscriber::fmt::init();
    let cli = Cli::parse();
    cli.run().await
}
```

### 2. **lib.rs** - åº“å…¥å£
**è·¯å¾„**: `src/lib.rs`  
**åŠŸèƒ½**: å®šä¹‰å…¬å…±APIå’Œæ¨¡å—å¯¼å‡º

**å¯¼å‡ºçš„æ ¸å¿ƒç±»å‹**:
- `TaskAgent` - é€šç”¨ä»»åŠ¡ä»£ç†ï¼ˆä¸»è¦ç±»å‹ï¼‰
- `CodeAgent` - TaskAgent çš„åˆ«åï¼ˆå·²åºŸå¼ƒï¼Œä¿ç•™å‘åå…¼å®¹ï¼‰
- `AgentConfig` - é…ç½®ç®¡ç†
- `LanguageModel` - AIæ¨¡å‹æ¥å£
- `Tool` - å·¥å…·ç³»ç»Ÿæ¥å£
- `PromptTemplate` - æç¤ºè¯æ¨¡æ¿
- `PlanningEngine` - ä»»åŠ¡ç†è§£å¼•æ“
- `TaskRequest/TaskResponse` - æœåŠ¡ç±»å‹ (éœ€è¦ "service" feature)

**æ¨¡å—ç»„ç»‡**:
```rust
pub mod agent;         // æ ¸å¿ƒä»£ç† (296è¡Œ) [é‡æ„ç²¾ç®€]
pub mod config;        // é…ç½®ç®¡ç†
pub mod models;        // AIæ¨¡å‹
pub mod prompts;       // æç¤ºè¯å·¥ç¨‹ç³»ç»Ÿ (300è¡Œ) [æ–°å¢]
pub mod parser;  // ä»»åŠ¡è¾…åŠ©å‡½æ•° (292è¡Œ) [æ–°å¢]
pub mod tools;         // å·¥å…·ç³»ç»Ÿ
pub mod types;         // ç±»å‹å®šä¹‰
pub mod errors;        // é”™è¯¯å¤„ç†
pub mod understanding; // ä»»åŠ¡ç†è§£ (186è¡Œ) [é‡æ„]
pub mod execution;     // ä»»åŠ¡æ‰§è¡Œ
pub mod cli;           // å‘½ä»¤è¡Œæ¥å£

#[cfg(feature = "service")]
pub mod service;       // HTTPæœåŠ¡ (å¯é€‰)
```

### 3. **agent.rs** - æ ¸å¿ƒä»»åŠ¡ä»£ç†
**è·¯å¾„**: `src/agent.rs` (296è¡Œï¼Œé‡æ„åå‡å°‘29%)
**åŠŸèƒ½**: å®ç°é€šç”¨çš„AIä»»åŠ¡ä»£ç†ï¼Œä¸“æ³¨äºä¸»å·¥ä½œæµç¨‹ï¼ˆç†è§£ã€æ‰§è¡Œåè°ƒã€ç»“æœç”Ÿæˆï¼‰

**æ ¸å¿ƒç»“æ„** (å·²ä¼˜åŒ–):
```rust
/// Main AI-Native Task Agent (struct, not trait)
///
/// A general-purpose agent that can handle various types of tasks including:
/// - Code generation and refactoring
/// - File operations
/// - Command execution
/// - Documentation
/// - Testing
/// - And any other tasks defined through the tool system
pub struct TaskAgent {
    model: Arc<dyn LanguageModel>,           // æ”¹ä¸ºArcæ”¯æŒå…±äº«
    tools: Arc<Mutex<ToolRegistry>>,
    config: AgentConfig,
    understanding_engine: PlanningEngine, // æ–°å¢ï¼šä¸“é—¨çš„ç†è§£å¼•æ“
    _error_handler: ErrorHandler,
}

/// Type alias for backward compatibility (deprecated)
#[deprecated(since = "0.2.1", note = "Use `TaskAgent` instead")]
pub type CodeAgent = TaskAgent;

impl TaskAgent {
    // å®ç°æ–¹æ³•
}
```

**é‡è¦è¯´æ˜**:
- `TaskAgent` æ˜¯ä¸€ä¸ª **struct**ï¼ˆç»“æ„ä½“ï¼‰ï¼Œä¸æ˜¯ traitï¼ˆç‰¹å¾ï¼‰
- ä» v0.2.1 å¼€å§‹ï¼Œ`CodeAgent` é‡å‘½åä¸º `TaskAgent` ä»¥ä½“ç°å…¶é€šç”¨æ€§
- `CodeAgent` ä½œä¸ºåˆ«åä¿ç•™ä»¥ä¿æŒå‘åå…¼å®¹ï¼Œä½†å·²æ ‡è®°ä¸º deprecated
- è¾…åŠ©å‡½æ•°ï¼ˆæ–‡ä»¶æ“ä½œã€å‘½ä»¤æ‰§è¡Œã€æ–‡æœ¬è§£æï¼‰å·²ç§»è‡³ `parser` æ¨¡å—

**èŒè´£åˆ†ç¦»**:
- `agent.rs` - ä¸»å·¥ä½œæµç¨‹ï¼šä»»åŠ¡ç†è§£ã€æ‰§è¡Œåè°ƒã€ç»“æœç”Ÿæˆ
- `parser.rs` - è¾…åŠ©åŠŸèƒ½ï¼šæ–‡ä»¶æ“ä½œã€å‘½ä»¤æ‰§è¡Œã€æ–‡æœ¬è§£æ

**ä¸»è¦æ–¹æ³•**:
- `new()` - åˆ›å»ºæ–°çš„ä»£ç†å®ä¾‹ï¼ˆè‡ªåŠ¨åˆ›å»ºç†è§£å¼•æ“ï¼‰
- `process_task()` - å¤„ç†ä»»åŠ¡çš„ä¸»å…¥å£
- `understand_task()` - å§”æ‰˜ç»™ PlanningEngine
- `execute_task_real()` - æ‰§è¡Œä»»åŠ¡
- `register_tool()` - æ³¨å†Œå·¥å…·
- `get_model()` - è·å–æ¨¡å‹å¼•ç”¨

**å·¥ä½œæµç¨‹** (ä¼˜åŒ–å):
1. æ¥æ”¶ä»»åŠ¡è¯·æ±‚
2. ç†è§£é˜¶æ®µ: å§”æ‰˜ç»™ PlanningEngineï¼ˆä½¿ç”¨æç¤ºè¯æ¨¡æ¿ï¼‰
3. æ‰§è¡Œé˜¶æ®µ: æ ¹æ®ç†è§£ç»“æœæ‰§è¡Œä»»åŠ¡
4. è¿”å›ç»“æœ

**é‡æ„æ”¹è¿›**:
- âœ… èŒè´£åˆ†ç¦»ï¼šç†è§£é€»è¾‘ç§»åˆ° understanding.rs
- âœ… ä»£ç ç²¾ç®€ï¼šä» 416 è¡Œå‡å°‘åˆ° 345 è¡Œ
- âœ… å…±äº«æ¨¡å‹ï¼šä½¿ç”¨ Arc æ”¯æŒå¤šç»„ä»¶å…±äº«

### 4. **cli.rs** - å‘½ä»¤è¡Œæ¥å£
**è·¯å¾„**: `src/cli.rs`  
**åŠŸèƒ½**: æä¾›å‘½ä»¤è¡Œäº¤äº’ç•Œé¢

**æ”¯æŒçš„å‘½ä»¤**:
- `task` - æ‰§è¡Œå•ä¸ªä»»åŠ¡
- `interactive` - è¿›å…¥äº¤äº’æ¨¡å¼
- `tools` - åˆ—å‡ºå¯ç”¨å·¥å…·
- `config` - æ˜¾ç¤ºé…ç½®

**è¾“å‡ºæ ¼å¼**:
- `text` - çº¯æ–‡æœ¬ (é»˜è®¤)
- `json` - JSONæ ¼å¼
- `verbose` - è¯¦ç»†è¾“å‡º

### 5. **config.rs** - é…ç½®ç®¡ç†
**è·¯å¾„**: `src/config.rs`  
**åŠŸèƒ½**: ç®¡ç†åº”ç”¨é…ç½®

**é…ç½®ç»“æ„**:
```rust
pub struct AgentConfig {
    pub model: ModelConfig,          // AIæ¨¡å‹é…ç½®
    pub execution: ExecutionConfig,  // æ‰§è¡Œé…ç½®
    pub safety: SafetyConfig,        // å®‰å…¨é…ç½®
    pub tools: ToolConfig,           // å·¥å…·é…ç½®
    pub logging: LoggingConfig,      // æ—¥å¿—é…ç½®
}
```

**æ”¯æŒçš„AIæä¾›å•†**:
- OpenAI (GPTç³»åˆ—)
- Anthropic (Claudeç³»åˆ—)
- Zhipu (GLMç³»åˆ—)
- Local (æœ¬åœ°æ¨¡å‹)

**é…ç½®åŠ è½½æ–¹å¼**:
1. ä»TOMLæ–‡ä»¶åŠ è½½
2. ä»ç¯å¢ƒå˜é‡åŠ è½½
3. ä½¿ç”¨é»˜è®¤é…ç½®

### 6. **models.rs** - AIæ¨¡å‹æŠ½è±¡
**è·¯å¾„**: `src/models.rs`
**åŠŸèƒ½**: å®šä¹‰AIæ¨¡å‹æ¥å£å’Œå®ç° (ä½¿ç”¨ llm-connector)

**æ ¸å¿ƒæ¥å£**:
```rust
#[async_trait]
pub trait LanguageModel: Send + Sync {
    async fn complete(&self, prompt: &str) -> Result<ModelResponse, ModelError>;
    async fn complete_with_tools(&self, prompt: &str, tools: &[ToolDefinition])
        -> Result<ModelResponse, ModelError>;
    fn model_name(&self) -> &str;
    fn supports_tools(&self) -> bool;
}
```

**å®ç°çš„æ¨¡å‹** (é€šè¿‡ llm-connector):
- `OpenAIModel` - OpenAI APIé›†æˆ (ä½¿ç”¨ llm-connector)
- `AnthropicModel` - Anthropic APIé›†æˆ (ä½¿ç”¨ llm-connector)
- `ZhipuModel` - æ™ºè°±AIé›†æˆ (ä½¿ç”¨ llm-connector)
- `LocalModel` - æœ¬åœ°æ¨¡å‹æ”¯æŒ (ä½¿ç”¨ llm-connector)
- `MockModel` - æµ‹è¯•ç”¨æ¨¡æ‹Ÿæ¨¡å‹

**é‡è¦å˜æ›´**: ä» v0.2.0 å¼€å§‹,æ‰€æœ‰ LLM è°ƒç”¨éƒ½é€šè¿‡ `llm-connector` crate ç»Ÿä¸€ç®¡ç†,æä¾›æ›´å¥½çš„åè®®é€‚é…å’Œé”™è¯¯å¤„ç†ã€‚è¯¦è§ [LLM Connector è¿ç§»æ–‡æ¡£](./LLM_CONNECTOR_MIGRATION.md)ã€‚

### 7. **tools.rs** - å·¥å…·ç³»ç»Ÿ
**è·¯å¾„**: `src/tools.rs`  
**åŠŸèƒ½**: å®šä¹‰å·¥å…·æ¥å£å’Œå†…ç½®å·¥å…·

**å·¥å…·æ¥å£**:
```rust
#[async_trait]
pub trait Tool: Send + Sync {
    fn name(&self) -> &str;
    fn description(&self) -> &str;
    fn parameters(&self) -> Vec<Parameter>;
    async fn execute(&self, args: &ToolArgs) -> Result<ToolResult, ToolError>;
}
```

**å†…ç½®å·¥å…·**:
- `ReadFileTool` - è¯»å–æ–‡ä»¶
- `WriteFileTool` - å†™å…¥æ–‡ä»¶
- `RunCommandTool` - æ‰§è¡Œå‘½ä»¤
- `ListFilesTool` - åˆ—å‡ºæ–‡ä»¶

**å·¥å…·æ³¨å†Œè¡¨**:
```rust
pub struct ToolRegistry {
    tools: HashMap<String, Box<dyn Tool>>,
}
```

### 8. **types.rs** - ç±»å‹å®šä¹‰
**è·¯å¾„**: `src/types.rs`  
**åŠŸèƒ½**: å®šä¹‰æ ¸å¿ƒæ•°æ®ç±»å‹

**ä¸»è¦ç±»å‹**:
- `Task` - ä»»åŠ¡è¡¨ç¤º
- `TaskStatus` - ä»»åŠ¡çŠ¶æ€ (Pending/InProgress/Completed/Failed)
- `TaskResult` - ä»»åŠ¡ç»“æœ
- `TaskPlan` - ä»»åŠ¡è®¡åˆ’
- `TaskComplexity` - å¤æ‚åº¦ (Simple/Moderate/Complex)
- `ExecutionContext` - æ‰§è¡Œä¸Šä¸‹æ–‡
- `ExecutionStep` - æ‰§è¡Œæ­¥éª¤
- `Action` - åŠ¨ä½œç±»å‹
- `ActionType` - åŠ¨ä½œç±»å‹æšä¸¾

### 9. **errors.rs** - é”™è¯¯å¤„ç†
**è·¯å¾„**: `src/errors.rs`  
**åŠŸèƒ½**: å®šä¹‰é”™è¯¯ç±»å‹å’Œå¤„ç†é€»è¾‘

**é”™è¯¯ç±»å‹**:
```rust
pub enum AgentError {
    ModelError(ModelError),
    ToolError(ToolError),
    NetworkError(String),
    TimeoutError,
    ConfigError(String),
    UnknownError(String),
}
```

**é”™è¯¯å¤„ç†å™¨**:
```rust
pub struct ErrorHandler {
    pub max_retries: u32,
    pub retry_delay_seconds: u64,
}
```

æ”¯æŒè‡ªåŠ¨é‡è¯•æœºåˆ¶,é’ˆå¯¹ç½‘ç»œé”™è¯¯ã€è¶…æ—¶å’Œé™æµé”™è¯¯ã€‚

### 10. **understanding.rs** - ä»»åŠ¡ç†è§£å¼•æ“
**è·¯å¾„**: `src/understanding.rs` (186è¡Œï¼Œé‡æ„åæ–°å¢)
**åŠŸèƒ½**: ä½¿ç”¨AIåˆ†æå’Œç†è§£ä»»åŠ¡ï¼Œé›†æˆæç¤ºè¯å·¥ç¨‹ç³»ç»Ÿ

**æ ¸å¿ƒç»“æ„**:
```rust
pub struct PlanningEngine {
    model: Arc<dyn LanguageModel>,
    prompt_template: PromptTemplate,  // æç¤ºè¯æ¨¡æ¿
}
```

**ä¸»è¦æ–¹æ³•**:
- `new()` - ä½¿ç”¨é»˜è®¤æ¨¡æ¿åˆ›å»ºå¼•æ“
- `with_template()` - ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ¿åˆ›å»ºå¼•æ“
- `load_template()` - ä»æ–‡ä»¶åŠ è½½æ¨¡æ¿
- `understand_task()` - åˆ†æä»»åŠ¡ï¼ˆè‡ªåŠ¨æ¨æ–­ç±»å‹ï¼‰
- `understand_task_with_type()` - åˆ†æä»»åŠ¡ï¼ˆæŒ‡å®šç±»å‹ï¼‰
- `build_understanding_prompt()` - æ„å»ºæç¤ºè¯ï¼ˆä½¿ç”¨æ¨¡æ¿ç³»ç»Ÿï¼‰
- `infer_task_type()` - æ¨æ–­ä»»åŠ¡ç±»å‹
- `parse_task_plan()` - è§£æAIå“åº”

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… ä½¿ç”¨æç¤ºè¯æ¨¡æ¿ç³»ç»Ÿæ„å»ºæç¤ºè¯
- âœ… è‡ªåŠ¨æ¨æ–­ä»»åŠ¡ç±»å‹ï¼ˆ9ç§åœºæ™¯ï¼‰
- âœ… è°ƒç”¨AIæ¨¡å‹åˆ†æä»»åŠ¡
- âœ… è§£æAIå“åº”ç”Ÿæˆä»»åŠ¡è®¡åˆ’
- âœ… è¯„ä¼°ä»»åŠ¡å¤æ‚åº¦
- âœ… è¯†åˆ«ä¾èµ–å’Œéœ€æ±‚

**ä»»åŠ¡ç±»å‹æ¨æ–­**:
- testing: test, unit test
- refactoring: refactor, improve
- debugging: debug, fix, error
- documentation: document, doc
- optimization: optimize, performance
- architecture: design, architecture
- file_operations: read, write, file
- command_execution: run, execute, command
- code_generation: create, generate, implement

### 11. **prompts.rs** - æç¤ºè¯å·¥ç¨‹ç³»ç»Ÿ
**è·¯å¾„**: `src/prompts.rs` (300è¡Œï¼Œæ–°å¢)
**åŠŸèƒ½**: çµæ´»çš„æç¤ºè¯æ¨¡æ¿ç³»ç»Ÿï¼Œå‚è€ƒ OpenAI Codex å’Œ Roo-Code

**æ ¸å¿ƒç»“æ„**:
```rust
pub struct PromptTemplate {
    pub global: GlobalTemplate,              // å…¨å±€æ¨¡æ¿
    pub project: Option<ProjectRules>,       // é¡¹ç›®è§„åˆ™
    pub scenarios: HashMap<String, ScenarioPrompt>, // åœºæ™¯æç¤ºè¯
}

pub struct PromptBuilder {
    template: PromptTemplate,
    task_type: Option<String>,
    context: HashMap<String, String>,
}
```

**ä¸»è¦ç»„ä»¶**:
- `GlobalTemplate` - ç³»ç»Ÿè§’è‰²ã€è¾“å‡ºæ ¼å¼ã€çº¦æŸ
- `ProjectRules` - æŠ€æœ¯æ ˆã€è§„èŒƒã€ä¸Šä¸‹æ–‡
- `ScenarioPrompt` - åœºæ™¯ç‰¹å®šæŒ‡ä»¤å’Œç¤ºä¾‹
- `OutputFormat` - è¾“å‡ºæ ¼å¼è§„èŒƒ
- `PromptExample` - Few-shot ç¤ºä¾‹

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… åˆ†å±‚æç¤ºè¯ç»“æ„ï¼ˆå…¨å±€+é¡¹ç›®+åœºæ™¯ï¼‰
- âœ… YAML å¤–ç½®é…ç½®
- âœ… æµå¼ API æ„å»ºå™¨
- âœ… åŠ¨æ€ä¸Šä¸‹æ–‡æ³¨å…¥
- âœ… æ¨¡æ¿åŠ è½½å’Œä¿å­˜
- âœ… 9+ é¢„å®šä¹‰åœºæ™¯

**å†…ç½®åœºæ™¯**:
1. code_generation - ä»£ç ç”Ÿæˆ
2. refactoring - ä»£ç é‡æ„
3. debugging - è°ƒè¯•ä¿®å¤
4. testing - æµ‹è¯•ç¼–å†™
5. documentation - æ–‡æ¡£ç¼–å†™
6. architecture - æ¶æ„è®¾è®¡
7. optimization - æ€§èƒ½ä¼˜åŒ–
8. file_operations - æ–‡ä»¶æ“ä½œ
9. command_execution - å‘½ä»¤æ‰§è¡Œ

**é…ç½®æ–‡ä»¶**:
- `prompts/default.yaml` - é»˜è®¤æ¨¡æ¿
- `prompts/rust-project.yaml` - Rust é¡¹ç›®æ¨¡æ¿

è¯¦è§ï¼š[æç¤ºè¯å·¥ç¨‹æ–‡æ¡£](./PROMPT_ENGINEERING.md)

### 12. **parser.rs** - ä»»åŠ¡è¾…åŠ©å‡½æ•°
**è·¯å¾„**: `src/parser.rs` (292è¡Œï¼Œæ–°å¢)
**åŠŸèƒ½**: æä¾›ä»»åŠ¡æ‰§è¡Œçš„è¾…åŠ©åŠŸèƒ½ï¼Œä» agent.rs åˆ†ç¦»å‡ºæ¥

**æ ¸å¿ƒå‡½æ•°**:
```rust
// æ–‡æœ¬è§£æ
pub fn extract_file_path(text: &str) -> Option<String>
pub fn extract_command(text: &str) -> Option<String>
pub fn extract_directory_path(text: &str) -> Option<String>

// æ–‡ä»¶æ“ä½œ
pub async fn read_file(path: &str) -> Result<String, AgentError>
pub async fn list_files(path: &str) -> Result<String, AgentError>

// å‘½ä»¤æ‰§è¡Œ
pub async fn run_command(command: &str) -> Result<String, AgentError>
```

**ä¸»è¦åŠŸèƒ½**:
- âœ… **æ–‡æœ¬è§£æ**: ä»è‡ªç„¶è¯­è¨€ä¸­æå–æ–‡ä»¶è·¯å¾„ã€å‘½ä»¤ã€ç›®å½•è·¯å¾„
- âœ… **æ–‡ä»¶æ“ä½œ**: è¯»å–æ–‡ä»¶ã€åˆ—å‡ºç›®å½•å†…å®¹
- âœ… **å‘½ä»¤æ‰§è¡Œ**: æ‰§è¡Œ shell å‘½ä»¤å¹¶è¿”å›è¾“å‡º
- âœ… **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œå‹å¥½çš„é”™è¯¯æ¶ˆæ¯
- âœ… **æµ‹è¯•è¦†ç›–**: 7 ä¸ªå•å…ƒæµ‹è¯• + 2 ä¸ªæ–‡æ¡£æµ‹è¯•

**è®¾è®¡ä¼˜åŠ¿**:
- ç‹¬ç«‹æ¨¡å—ï¼ŒèŒè´£å•ä¸€
- çº¯å‡½æ•°è®¾è®¡ï¼Œæ˜“äºæµ‹è¯•
- å¯è¢«å…¶ä»–æ¨¡å—å¤ç”¨
- ä¿æŒ agent.rs ç®€æ´æ¸…æ™°

**æ”¯æŒçš„æ–‡ä»¶æ‰©å±•å**:
- ä»£ç : .rs, .py, .js, .ts, .go, .java, .c, .cpp, .h
- é…ç½®: .toml, .yaml, .yml, .json, .xml
- æ–‡æ¡£: .txt, .md
- è„šæœ¬: .sh, .bash, .zsh, .fish

### 13. **execution.rs** - ä»»åŠ¡æ‰§è¡Œå¼•æ“
**è·¯å¾„**: `src/execution.rs`
**åŠŸèƒ½**: æ‰§è¡Œä»»åŠ¡è®¡åˆ’

**æ‰§è¡Œæµç¨‹**:
1. åˆ›å»ºæ‰§è¡Œä¸Šä¸‹æ–‡
2. AIå†³ç­–ä¸‹ä¸€æ­¥åŠ¨ä½œ
3. æ‰§è¡ŒåŠ¨ä½œ (ä½¿ç”¨å·¥å…·/æ€è€ƒ/å®Œæˆ)
4. è®°å½•ç»“æœ
5. å¾ªç¯ç›´åˆ°ä»»åŠ¡å®Œæˆ

**åŠ¨ä½œç±»å‹**:
- `UseTool` - ä½¿ç”¨å·¥å…·
- `Think` - æ€è€ƒæ¨ç†
- `Complete` - å®Œæˆä»»åŠ¡
- `AskClarification` - è¯·æ±‚æ¾„æ¸…

### 12. **service/** - HTTPæœåŠ¡æ¨¡å—
**è·¯å¾„**: `src/service/`  
**åŠŸèƒ½**: æä¾›HTTP REST API (éœ€è¦ "service" feature)

**å­æ¨¡å—**:
- `mod.rs` - æ¨¡å—å¯¼å‡º
- `core.rs` - æ ¸å¿ƒæœåŠ¡å®ç° (`CodeAgentService`)
- `api.rs` - HTTP APIè·¯ç”±å’Œå¤„ç†å™¨
- `error.rs` - æœåŠ¡é”™è¯¯ç±»å‹
- `metrics.rs` / `metrics_simple.rs` - æŒ‡æ ‡æ”¶é›†

**APIç«¯ç‚¹**:
- `POST /api/v1/tasks` - æ‰§è¡Œå•ä¸ªä»»åŠ¡
- `POST /api/v1/tasks/batch` - æ‰¹é‡æ‰§è¡Œä»»åŠ¡
- `GET /health` - å¥åº·æ£€æŸ¥
- `GET /metrics` - æŒ‡æ ‡æŸ¥è¯¢

### 13. **service_types.rs** - æœåŠ¡ç±»å‹å®šä¹‰
**è·¯å¾„**: `src/service_types.rs`  
**åŠŸèƒ½**: å®šä¹‰æœåŠ¡ç›¸å…³çš„æ•°æ®ç±»å‹

**ä¸»è¦ç±»å‹**:
- `TaskRequest` - ä»»åŠ¡è¯·æ±‚
- `TaskResponse` - ä»»åŠ¡å“åº”
- `BatchTaskRequest` - æ‰¹é‡ä»»åŠ¡è¯·æ±‚
- `BatchTaskResponse` - æ‰¹é‡ä»»åŠ¡å“åº”
- `TaskContext` - ä»»åŠ¡ä¸Šä¸‹æ–‡
- `TaskPriority` - ä»»åŠ¡ä¼˜å…ˆçº§
- `ServiceConfig` - æœåŠ¡é…ç½®
- `ServiceStatus` - æœåŠ¡çŠ¶æ€

## ç›®å½•ç»“æ„

```
task-runner/
â”œâ”€â”€ Cargo.toml              # é¡¹ç›®é…ç½®å’Œä¾èµ–
â”œâ”€â”€ Cargo.lock              # ä¾èµ–é”å®šæ–‡ä»¶
â”œâ”€â”€ config.toml             # è¿è¡Œæ—¶é…ç½®æ–‡ä»¶
â”œâ”€â”€ README.md               # é¡¹ç›®è¯´æ˜ (è‹±æ–‡)
â”œâ”€â”€ README_CN.md            # é¡¹ç›®è¯´æ˜ (ä¸­æ–‡)
â”‚
â”œâ”€â”€ src/                    # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ main.rs            # ç¨‹åºå…¥å£
â”‚   â”œâ”€â”€ lib.rs             # åº“å…¥å£
â”‚   â”œâ”€â”€ agent.rs           # æ ¸å¿ƒä»»åŠ¡ä»£ç† (296è¡Œï¼Œé‡æ„ç²¾ç®€)
â”‚   â”œâ”€â”€ cli.rs             # å‘½ä»¤è¡Œæ¥å£
â”‚   â”œâ”€â”€ config.rs          # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ errors.rs          # é”™è¯¯å¤„ç†
â”‚   â”œâ”€â”€ execution.rs       # æ‰§è¡Œå¼•æ“
â”‚   â”œâ”€â”€ models.rs          # AIæ¨¡å‹
â”‚   â”œâ”€â”€ prompts.rs         # æç¤ºè¯å·¥ç¨‹ç³»ç»Ÿ (300è¡Œï¼Œæ–°å¢)
â”‚   â”œâ”€â”€ parser.rs    # ä»»åŠ¡è¾…åŠ©å‡½æ•° (292è¡Œï¼Œæ–°å¢)
â”‚   â”œâ”€â”€ tools.rs           # å·¥å…·ç³»ç»Ÿ
â”‚   â”œâ”€â”€ types.rs           # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ understanding.rs   # ç†è§£å¼•æ“ (186è¡Œï¼Œé‡æ„å)
â”‚   â”œâ”€â”€ service_types.rs   # æœåŠ¡ç±»å‹
â”‚   â”‚
â”‚   â”œâ”€â”€ server/            # æœåŠ¡å™¨ç›¸å…³
â”‚   â”‚   â””â”€â”€ main.rs        # HTTPæœåŠ¡å™¨å…¥å£
â”‚   â”‚
â”‚   â””â”€â”€ service/           # æœåŠ¡æ¨¡å—
â”‚       â”œâ”€â”€ mod.rs         # æ¨¡å—å¯¼å‡º
â”‚       â”œâ”€â”€ core.rs        # æ ¸å¿ƒæœåŠ¡
â”‚       â”œâ”€â”€ api.rs         # APIè·¯ç”±
â”‚       â”œâ”€â”€ error.rs       # æœåŠ¡é”™è¯¯
â”‚       â”œâ”€â”€ metrics.rs     # æŒ‡æ ‡æ”¶é›†
â”‚       â””â”€â”€ metrics_simple.rs  # ç®€åŒ–æŒ‡æ ‡
â”‚
â”œâ”€â”€ doc/                   # æ–‡æ¡£ç›®å½•
â”‚   â”œâ”€â”€ CODE_STRUCTURE.md  # ä»£ç ç»“æ„æ–‡æ¡£ (æœ¬æ–‡ä»¶)
â”‚   â”œâ”€â”€ PROMPT_ENGINEERING.md  # æç¤ºè¯å·¥ç¨‹æ–‡æ¡£ (æ–°å¢)
â”‚   â”œâ”€â”€ REFACTORING_GUIDE.md   # é‡æ„æŒ‡å— (æ–°å¢)
â”‚   â”œâ”€â”€ SERVICE_API.md     # APIæ–‡æ¡£
â”‚   â”œâ”€â”€ RUST_ANALYZER_SETUP.md  # å¼€å‘ç¯å¢ƒé…ç½®
â”‚   â”œâ”€â”€ system-design.md   # ç³»ç»Ÿè®¾è®¡ (è‹±æ–‡)
â”‚   â””â”€â”€ system-design-cn.md # ç³»ç»Ÿè®¾è®¡ (ä¸­æ–‡)
â”‚
â”œâ”€â”€ prompts/               # æç¤ºè¯æ¨¡æ¿ç›®å½• (æ–°å¢)
â”‚   â”œâ”€â”€ default.yaml       # é»˜è®¤æç¤ºè¯æ¨¡æ¿
â”‚   â””â”€â”€ rust-project.yaml  # Rusté¡¹ç›®ä¸“ç”¨æ¨¡æ¿
â”‚
â”œâ”€â”€ examples/              # ç¤ºä¾‹ä»£ç 
â”‚   â”œâ”€â”€ Cargo.toml         # ç¤ºä¾‹é¡¹ç›®é…ç½®
â”‚   â”œâ”€â”€ README.md          # ç¤ºä¾‹è¯´æ˜
â”‚   â”œâ”€â”€ http_client.rs     # HTTPå®¢æˆ·ç«¯ç¤ºä¾‹
â”‚   â”œâ”€â”€ in_process_service.rs  # è¿›ç¨‹å†…æœåŠ¡ç¤ºä¾‹
â”‚   â”œâ”€â”€ prompt_engineering.rs  # æç¤ºè¯å·¥ç¨‹ç¤ºä¾‹ (æ–°å¢)
â”‚   â””â”€â”€ rust_client.rs     # Rustå®¢æˆ·ç«¯ç¤ºä¾‹
â”‚
â”œâ”€â”€ ref/                   # å‚è€ƒå®ç°
â”‚   â”œâ”€â”€ mcp-client/        # MCPå®¢æˆ·ç«¯å‚è€ƒ
â”‚   â”œâ”€â”€ mcp-server/        # MCPæœåŠ¡å™¨å‚è€ƒ
â”‚   â””â”€â”€ mcp-types/         # MCPç±»å‹å®šä¹‰
â”‚
â””â”€â”€ target/                # ç¼–è¯‘è¾“å‡ºç›®å½•
    â””â”€â”€ debug/             # è°ƒè¯•æ„å»º
```

## ä¸»è¦åŠŸèƒ½æµç¨‹

### ä»»åŠ¡æ‰§è¡Œæµç¨‹

```
ç”¨æˆ·è¾“å…¥ä»»åŠ¡
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLI.run()          â”‚  è§£æå‘½ä»¤è¡Œå‚æ•°
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ create_agent()      â”‚  åˆ›å»ºAIä»£ç†å®ä¾‹
â”‚  - åŠ è½½é…ç½®         â”‚
â”‚  - åˆå§‹åŒ–æ¨¡å‹       â”‚
â”‚  - æ³¨å†Œå·¥å…·         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ agent.process_task()â”‚  å¤„ç†ä»»åŠ¡
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                 â”‚
       â–¼                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ understand_task()â”‚          â”‚ execute_task()   â”‚
â”‚  1. æ„å»ºæç¤ºè¯    â”‚          â”‚  1. åˆ›å»ºæ‰§è¡Œä¸Šä¸‹æ–‡â”‚
â”‚  2. è°ƒç”¨AIæ¨¡å‹    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  2. AIå†³ç­–åŠ¨ä½œ   â”‚
â”‚  3. è§£æå“åº”      â”‚          â”‚  3. æ‰§è¡ŒåŠ¨ä½œ     â”‚
â”‚  4. ç”Ÿæˆè®¡åˆ’      â”‚          â”‚  4. è®°å½•ç»“æœ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  è¿”å›TaskResult  â”‚
                              â”‚  - success       â”‚
                              â”‚  - summary       â”‚
                              â”‚  - details       â”‚
                              â”‚  - execution_timeâ”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### HTTPæœåŠ¡è¯·æ±‚æµç¨‹

```
HTTPè¯·æ±‚
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Axum Router        â”‚  è·¯ç”±åˆ†å‘
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Handler        â”‚  å¤„ç†è¯·æ±‚
â”‚  - execute_task     â”‚
â”‚  - batch_execute    â”‚
â”‚  - health_check     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CodeAgentService    â”‚  æœåŠ¡å±‚
â”‚  - ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†     â”‚
â”‚  - å¹¶å‘æ§åˆ¶         â”‚
â”‚  - æŒ‡æ ‡æ”¶é›†         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CodeAgent          â”‚  æ ¸å¿ƒä»£ç†
â”‚  (åŒä¸Šè¿°æµç¨‹)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### AIæ¨¡å‹è°ƒç”¨æµç¨‹

```
prompt (æç¤ºè¯)
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LanguageModel trait â”‚  æ¨¡å‹æ¥å£
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼          â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OpenAI   â”‚ â”‚Anthropic â”‚ â”‚  Zhipu   â”‚ â”‚  Local   â”‚
â”‚  Model   â”‚ â”‚  Model   â”‚ â”‚  Model   â”‚ â”‚  Model   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚            â”‚            â”‚            â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  ModelResponse   â”‚
          â”‚  - content       â”‚
          â”‚  - tool_calls    â”‚
          â”‚  - usage         â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å·¥å…·æ‰§è¡Œæµç¨‹

```
å·¥å…·è°ƒç”¨è¯·æ±‚
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ToolRegistry       â”‚  å·¥å…·æ³¨å†Œè¡¨
â”‚  - get_tool()       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tool.execute()     â”‚  æ‰§è¡Œå·¥å…·
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼          â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ReadFile  â”‚ â”‚WriteFile â”‚ â”‚RunCommandâ”‚ â”‚ListFiles â”‚
â”‚  Tool    â”‚ â”‚  Tool    â”‚ â”‚  Tool    â”‚ â”‚  Tool    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚            â”‚            â”‚            â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   ToolResult     â”‚
          â”‚  - success       â”‚
          â”‚  - content       â”‚
          â”‚  - summary       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¾èµ–å…³ç³»

### æ ¸å¿ƒä¾èµ–

**å¼‚æ­¥è¿è¡Œæ—¶**:
- `tokio` (1.0) - å¼‚æ­¥è¿è¡Œæ—¶,æ”¯æŒå®Œæ•´ç‰¹æ€§
- `async-trait` (0.1) - å¼‚æ­¥traitæ”¯æŒ
- `futures` (0.3) - Futureå·¥å…·

**HTTPç›¸å…³**:
- `reqwest` (0.11) - HTTPå®¢æˆ·ç«¯
- `axum` (0.7) - HTTPæœåŠ¡å™¨æ¡†æ¶ [å¯é€‰]
- `tower` (0.4) - ä¸­é—´ä»¶æ”¯æŒ [å¯é€‰]
- `tower-http` (0.5) - HTTPä¸­é—´ä»¶ (CORS, tracing) [å¯é€‰]

**LLMé›†æˆ**:
- `llm-connector` (0.2.0) - ç»Ÿä¸€çš„ LLM æä¾›å•†æ¥å£

**åºåˆ—åŒ–**:
- `serde` (1.0) - åºåˆ—åŒ–æ¡†æ¶
- `serde_json` (1.0) - JSONæ”¯æŒ
- `toml` (0.8) - TOMLé…ç½®æ–‡ä»¶

**å·¥å…·åº“**:
- `uuid` (1.0) - UUIDç”Ÿæˆ
- `chrono` (0.4) - æ—¶é—´å¤„ç†
- `clap` (4.0) - å‘½ä»¤è¡Œè§£æ
- `anyhow` (1.0) - é”™è¯¯å¤„ç†
- `thiserror` (1.0) - é”™è¯¯å®šä¹‰

**æ—¥å¿—**:
- `tracing` (0.1) - ç»“æ„åŒ–æ—¥å¿—
- `tracing-subscriber` (0.3) - æ—¥å¿—è®¢é˜…å™¨

**ç›‘æ§** [å¯é€‰]:
- `metrics` (0.23) - æŒ‡æ ‡æ”¶é›†
- `metrics-exporter-prometheus` (0.13) - Prometheuså¯¼å‡º

### Featureæ ‡å¿—

```toml
[features]
default = ["core"]
core = []                    # æ ¸å¿ƒåŠŸèƒ½
service = [                  # HTTPæœåŠ¡åŠŸèƒ½
    "axum",
    "tower",
    "tower-http",
    "metrics",
    "metrics-exporter-prometheus"
]
full = ["core", "service"]   # å®Œæ•´åŠŸèƒ½
```

### æ¨¡å—ä¾èµ–å›¾

```
main.rs
  â””â”€â–º cli.rs
       â”œâ”€â–º agent.rs
       â”‚    â”œâ”€â–º models.rs
       â”‚    â”œâ”€â–º tools.rs
       â”‚    â”œâ”€â–º understanding.rs
       â”‚    â”œâ”€â–º execution.rs
       â”‚    â”œâ”€â–º types.rs
       â”‚    â”œâ”€â–º errors.rs
       â”‚    â””â”€â–º config.rs
       â””â”€â–º config.rs

lib.rs
  â”œâ”€â–º agent.rs
  â”œâ”€â–º cli.rs
  â”œâ”€â–º config.rs
  â”œâ”€â–º models.rs
  â”œâ”€â–º tools.rs
  â”œâ”€â–º types.rs
  â”œâ”€â–º errors.rs
  â”œâ”€â–º understanding.rs
  â”œâ”€â–º execution.rs
  â”œâ”€â–º service_types.rs [feature="service"]
  â””â”€â–º service/ [feature="service"]
       â”œâ”€â–º mod.rs
       â”œâ”€â–º core.rs
       â”œâ”€â–º api.rs
       â”œâ”€â–º error.rs
       â””â”€â–º metrics.rs

server/main.rs [feature="service"]
  â””â”€â–º service/
       â””â”€â–º api.rs
```

## å…³é”®è®¾è®¡æ¨¡å¼

### 1. TraitæŠ½è±¡æ¨¡å¼
ä½¿ç”¨Rustçš„traitç³»ç»Ÿå®ç°æ¥å£æŠ½è±¡:
- `LanguageModel` trait - æ”¯æŒå¤šç§AIæ¨¡å‹
- `Tool` trait - å¯æ‰©å±•çš„å·¥å…·ç³»ç»Ÿ

### 2. å¼‚æ­¥å¹¶å‘æ¨¡å¼
å…¨é¢ä½¿ç”¨async/awaitå’Œtokioè¿è¡Œæ—¶:
- æ‰€æœ‰IOæ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„
- æ”¯æŒå¹¶å‘ä»»åŠ¡æ‰§è¡Œ
- ä½¿ç”¨Arcå’ŒMutexå®ç°çº¿ç¨‹å®‰å…¨çš„å…±äº«çŠ¶æ€

### 3. é”™è¯¯å¤„ç†æ¨¡å¼
ä½¿ç”¨thiserrorå®šä¹‰ç»“æ„åŒ–é”™è¯¯:
- åˆ†å±‚é”™è¯¯ç±»å‹ (AgentError, ModelError, ToolError)
- æ”¯æŒé”™è¯¯è½¬æ¢å’Œä¼ æ’­
- å†…ç½®é‡è¯•æœºåˆ¶

### 4. é…ç½®ç®¡ç†æ¨¡å¼
å¤šå±‚é…ç½®åŠ è½½ç­–ç•¥:
- æ–‡ä»¶é…ç½® (TOML)
- ç¯å¢ƒå˜é‡
- é»˜è®¤å€¼
- æ”¯æŒç¯å¢ƒå˜é‡æ›¿æ¢

### 5. æœåŠ¡æ¶æ„æ¨¡å¼
å¯é€‰çš„HTTPæœåŠ¡å±‚:
- æ ¸å¿ƒé€»è¾‘ä¸æœåŠ¡å±‚åˆ†ç¦»
- æ”¯æŒè¿›ç¨‹å†…è°ƒç”¨å’ŒHTTPè°ƒç”¨
- ç»Ÿä¸€çš„å®¢æˆ·ç«¯æ¥å£

## æ‰©å±•ç‚¹

### æ·»åŠ æ–°çš„AIæ¨¡å‹
1. å®ç° `LanguageModel` trait
2. åœ¨ `config.rs` ä¸­æ·»åŠ æ–°çš„ `ModelProvider` å˜ä½“
3. åœ¨ `cli.rs` çš„ `create_agent()` ä¸­æ·»åŠ åˆ›å»ºé€»è¾‘

### æ·»åŠ æ–°çš„å·¥å…·
1. å®ç° `Tool` trait
2. åœ¨ `agent.rs` çš„ `create_agent()` ä¸­æ³¨å†Œå·¥å…·
3. å¯é€‰: åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ å·¥å…·é…ç½®

### æ·»åŠ æ–°çš„APIç«¯ç‚¹
1. åœ¨ `service/api.rs` ä¸­å®šä¹‰æ–°çš„å¤„ç†å‡½æ•°
2. åœ¨è·¯ç”±ä¸­æ³¨å†Œæ–°ç«¯ç‚¹
3. åœ¨ `service_types.rs` ä¸­å®šä¹‰è¯·æ±‚/å“åº”ç±»å‹

## æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
æ¯ä¸ªæ¨¡å—éƒ½åŒ…å«å•å…ƒæµ‹è¯•:
- `agent.rs` - ä»£ç†åˆ›å»ºå’Œå·¥å…·æ³¨å†Œæµ‹è¯•
- `models.rs` - æ¨¡å‹å“åº”æµ‹è¯•
- `tools.rs` - å·¥å…·æ‰§è¡Œæµ‹è¯•

### é›†æˆæµ‹è¯•
åœ¨ `examples/` ç›®å½•ä¸­æä¾›é›†æˆæµ‹è¯•ç¤ºä¾‹:
- `http_client.rs` - HTTP APIæµ‹è¯•
- `in_process_service.rs` - è¿›ç¨‹å†…æœåŠ¡æµ‹è¯•
- `rust_client.rs` - Rustå®¢æˆ·ç«¯æµ‹è¯•

### æµ‹è¯•å·¥å…·
- `MockModel` - æ¨¡æ‹ŸAIæ¨¡å‹ç”¨äºæµ‹è¯•
- `tokio-test` - å¼‚æ­¥æµ‹è¯•æ”¯æŒ
- `mockall` - Mockæ¡†æ¶

## æ€§èƒ½è€ƒè™‘

### å¹¶å‘å¤„ç†
- ä½¿ç”¨tokioçš„å¼‚æ­¥è¿è¡Œæ—¶
- æ”¯æŒå¹¶å‘ä»»åŠ¡æ‰§è¡Œ
- å·¥å…·æ³¨å†Œè¡¨ä½¿ç”¨Arc<Mutex<>>å®ç°çº¿ç¨‹å®‰å…¨

### èµ„æºç®¡ç†
- è¿æ¥æ± å¤ç”¨ (HTTPå®¢æˆ·ç«¯)
- åˆç†çš„è¶…æ—¶è®¾ç½®
- é™æµå’Œä¼˜å…ˆçº§é˜Ÿåˆ—

### ä¼˜åŒ–é€‰é¡¹
- Releaseæ¨¡å¼ä½¿ç”¨ `opt-level = 3`
- å¯é€‰çš„æŒ‡æ ‡æ”¶é›† (ä»…åœ¨éœ€è¦æ—¶å¯ç”¨)
- æŒ‰éœ€åŠ è½½çš„featureæ ‡å¿—

## å®‰å…¨è€ƒè™‘

### å®‰å…¨é…ç½®
- `SafetyConfig` - å®‰å…¨æ£€æŸ¥é…ç½®
- `allowed_directories` - å…è®¸çš„ç›®å½•åˆ—è¡¨
- `blocked_commands` - ç¦æ­¢çš„å‘½ä»¤åˆ—è¡¨

### APIå®‰å…¨
- CORSé…ç½®
- å¯æ‰©å±•çš„è®¤è¯æœºåˆ¶
- è¯·æ±‚éªŒè¯

### é”™è¯¯å¤„ç†
- ä¸æš´éœ²æ•æ„Ÿä¿¡æ¯
- ç»“æ„åŒ–é”™è¯¯æ—¥å¿—
- ä¼˜é›…çš„é”™è¯¯æ¢å¤

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2025-10-06
**ç»´æŠ¤è€…**: Task Runner Team

