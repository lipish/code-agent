use std::sync::Arc;
use std::fs::File;
use std::io::Write;
use agent_runner::models::{LlmModel, LanguageModel};
use agent_runner::config::{ModelConfig, ModelProvider};
use agent_runner::prompts::{PromptBuilder, PromptTemplate};
use std::env;

/// ç›´æ¥æ•è·LongCatæ¨¡å‹çš„åŸå§‹å“åº”
#[tokio::main]
async fn main() {
    let api_key = env::var("LONGCAT_API_KEY")
        .expect("è¯·è®¾ç½®ç¯å¢ƒå˜é‡ LONGCAT_API_KEY");
    
    println!("\nğŸš€ æ•è·LongCatæ¨¡å‹åŸå§‹å“åº”");
    println!("{}", "=".repeat(80));
    
    let model_config = ModelConfig {
        provider: ModelProvider::LongCat,
        model_name: "LongCat-Flash-Chat".to_string(),
        api_key: Some(api_key),
        endpoint: None,
        max_tokens: 4096,
        temperature: 0.7,
    };
    
    let model = Arc::new(LlmModel::from_config(model_config)
        .expect("åˆ›å»ºLongCatæ¨¡å‹å¤±è´¥"));
    
    let mut output_file = File::create("longcat_raw_responses.md")
        .expect("æ— æ³•åˆ›å»ºè¾“å‡ºæ–‡ä»¶");
    
    writeln!(output_file, "# LongCat-Flash-Chat åŸå§‹å“åº”å®Œæ•´è®°å½•\n").unwrap();
    writeln!(output_file, "**æµ‹è¯•æ—¶é—´**: 2025-10-13").unwrap();
    writeln!(output_file, "**æ¨¡å‹**: LongCat-Flash-Chat").unwrap();
    writeln!(output_file, "**æä¾›å•†**: LongCat (https://api.longcat.chat)\n").unwrap();
    writeln!(output_file, "---\n").unwrap();
    
    // ä½¿ç”¨é»˜è®¤promptæ¨¡æ¿
    let template = PromptTemplate::default();
    
    let scenarios = vec![
        (
            "åœºæ™¯1: ä»£ç†å•†Licenseç®¡ç†ç³»ç»Ÿ",
            r#"ä¸ºä¸€å®¶è½¯ä»¶å…¬å¸è®¾è®¡å’Œå®ç°ä¸€ä¸ªä»£ç†å•†Licenseç®¡ç†ç³»ç»Ÿã€‚è¯¥ç³»ç»Ÿéœ€è¦æ”¯æŒï¼š
1. å¤šçº§ä»£ç†å•†å±‚æ¬¡ç»“æ„ç®¡ç†ï¼ˆæ€»ä»£ç†ã€åŒºåŸŸä»£ç†ã€ç»é”€å•†ä¸‰çº§ä½“ç³»ï¼‰
2. Licenseçš„ç”Ÿæˆã€åˆ†é…ã€æ¿€æ´»å’ŒåŠé”€åŠŸèƒ½
3. ä¸åŒç±»å‹äº§å“çš„Licenseç®¡ç†ï¼ˆè¯•ç”¨ç‰ˆ30å¤©ã€æ ‡å‡†ç‰ˆæ°¸ä¹…ã€ä¼ä¸šç‰ˆæŒ‰å¹´è®¢é˜…ï¼‰
4. Licenseä½¿ç”¨æƒ…å†µçš„å®æ—¶ç›‘æ§å’ŒæŠ¥å‘Šï¼ˆæ¿€æ´»è®¾å¤‡æ•°ã€ä½¿ç”¨æ—¶é•¿ã€åŠŸèƒ½æ¨¡å—ä½¿ç”¨æƒ…å†µï¼‰
5. ä»£ç†å•†æƒé™å’Œé…é¢ç®¡ç†ï¼ˆæ¯ä¸ªä»£ç†å•†å¯åˆ†é…çš„Licenseæ•°é‡é™åˆ¶ï¼‰
6. è‡ªåŠ¨ç»­è´¹å’Œåˆ°æœŸæé†’åŠŸèƒ½ï¼ˆé‚®ä»¶ã€çŸ­ä¿¡ã€ç³»ç»Ÿé€šçŸ¥ï¼‰
7. å®‰å…¨çš„LicenseéªŒè¯æœºåˆ¶ï¼ˆRSAåŠ å¯†ã€ç¦»çº¿éªŒè¯ã€é˜²ç¯¡æ”¹ï¼‰
8. æ”¯æŒç¦»çº¿LicenseéªŒè¯ï¼ˆé€‚ç”¨äºæ— ç½‘ç»œç¯å¢ƒï¼‰
9. Licenseæ‰¹é‡å¯¼å…¥å¯¼å‡ºåŠŸèƒ½
10. å®Œæ•´çš„æ“ä½œæ—¥å¿—å’Œå®¡è®¡è·Ÿè¸ª
è¯¥ç³»ç»Ÿéœ€è¦å…·å¤‡é«˜å®‰å…¨æ€§ã€å¯æ‰©å±•æ€§ï¼Œå¹¶æ”¯æŒREST APIæ¥å£ä¾›ç¬¬ä¸‰æ–¹ç³»ç»Ÿé›†æˆã€‚"#
        ),
        (
            "åœºæ™¯2: æ™ºèƒ½æŠ•èµ„ç»„åˆæ„å»ºå’Œåˆ†æç³»ç»Ÿ",
            r#"å¼€å‘ä¸€ä¸ªæ™ºèƒ½æŠ•èµ„ç»„åˆæ„å»ºå’Œåˆ†æç³»ç»Ÿï¼Œéœ€è¦å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š
1. å¤šèµ„äº§ç±»åˆ«æ”¯æŒï¼ˆè‚¡ç¥¨ã€å€ºåˆ¸ã€åŸºé‡‘ã€ETFã€æœŸè´§ã€å¤–æ±‡ã€å•†å“ã€REITsç­‰ï¼‰
2. å®æ—¶å¸‚åœºæ•°æ®è·å–å’Œå¤„ç†ï¼ˆä»·æ ¼ã€æˆäº¤é‡ã€è´¢åŠ¡æŒ‡æ ‡ã€å®è§‚ç»æµæ•°æ®ï¼‰
3. æ™ºèƒ½èµ„äº§é…ç½®ç®—æ³•ï¼ˆç°ä»£æŠ•èµ„ç»„åˆç†è®ºMPTã€é£é™©å¹³ä»·ã€Black-Littermanæ¨¡å‹ã€å› å­æ¨¡å‹ç­‰ï¼‰
4. å…¨é¢é£é™©ç®¡ç†å’Œè¯„ä¼°ï¼ˆVaRã€CVaRã€æœ€å¤§å›æ’¤ã€å¤æ™®æ¯”ç‡ã€ç´¢æè¯ºæ¯”ç‡ã€ä¿¡æ¯æ¯”ç‡ç­‰ï¼‰
5. å¼ºå¤§çš„å›æµ‹å¼•æ“æ”¯æŒå†å²ç­–ç•¥éªŒè¯ï¼ˆæ”¯æŒå¤šå› å­å›æµ‹ã€æ»‘ç‚¹æˆæœ¬æ¨¡æ‹Ÿï¼‰
6. å®æ—¶æŠ•èµ„ç»„åˆç›‘æ§å’Œæ™ºèƒ½é¢„è­¦ç³»ç»Ÿï¼ˆåç¦»ç›®æ ‡é…ç½®ã€é£é™©é˜ˆå€¼çªç ´ç­‰ï¼‰
7. ä¸ªæ€§åŒ–æŠ•èµ„å»ºè®®ç”Ÿæˆï¼ˆåŸºäºç”¨æˆ·é£é™©åå¥½ã€æŠ•èµ„ç›®æ ‡ã€æ—¶é—´æœŸé™ï¼‰
8. ç¨åŠ¡ä¼˜åŒ–å’Œäº¤æ˜“æˆæœ¬åˆ†æï¼ˆç¨æ”¶æŸå¤±æ”¶å‰²ã€æ¢æ‰‹ç‡ä¼˜åŒ–ï¼‰
9. ESGè¯„åˆ†é›†æˆå’Œå¯æŒç»­æŠ•èµ„ç­›é€‰
10. æœºå™¨å­¦ä¹ é©±åŠ¨çš„å¸‚åœºé¢„æµ‹æ¨¡å‹ï¼ˆLSTMã€Transformerã€å¼ºåŒ–å­¦ä¹ ç­‰ï¼‰
11. å¤šè¯­è¨€æŠ¥å‘Šç”Ÿæˆï¼ˆä¸­æ–‡ã€è‹±æ–‡ã€PDFã€Excelæ ¼å¼ï¼‰
12. ç§»åŠ¨ç«¯å’ŒWebç«¯ç•Œé¢æ”¯æŒï¼Œæ•°æ®å¯è§†åŒ–ï¼ˆäº¤äº’å¼å›¾è¡¨ã€çƒ­åŠ›å›¾ã€ç›¸å…³æ€§çŸ©é˜µï¼‰
13. æ”¯æŒç»„åˆå‹åŠ›æµ‹è¯•å’Œæƒ…æ™¯åˆ†æ
14. ä¸åˆ¸å•†äº¤æ˜“ç³»ç»Ÿå¯¹æ¥å®ç°è‡ªåŠ¨åŒ–äº¤æ˜“
è¯¥ç³»ç»Ÿéœ€è¦å¤„ç†å¤§é‡å®æ—¶æ•°æ®æµï¼Œæ”¯æŒé«˜å¹¶å‘ç”¨æˆ·è®¿é—®ï¼Œå…·å¤‡è‰¯å¥½çš„æ‰©å±•æ€§å’Œå®¹é”™æ€§ã€‚"#
        ),
        (
            "åœºæ™¯3: å¤šåˆ†æ”¯æœºæ„ä¼šè®®å®¤é¢„å®šç®¡ç†ç³»ç»Ÿ",
            r#"ä¸ºä¸€ä¸ªå¤§å‹ä¼ä¸šé›†å›¢å¼€å‘å¤šåˆ†æ”¯æœºæ„ä¼šè®®å®¤é¢„å®šç®¡ç†ç³»ç»Ÿï¼Œéœ€è¦æ”¯æŒï¼š
1. å¤šåŸå¸‚åˆ†æ”¯æœºæ„ç®¡ç†ï¼ˆåŒ—äº¬ã€ä¸Šæµ·ã€æ·±åœ³ã€æˆéƒ½ã€å¹¿å·ã€æ­å·ç­‰20+åŸå¸‚ï¼‰
2. ä¸åŒç±»å‹ä¼šè®®å®¤ç®¡ç†ï¼ˆå°å‹è®¨è®ºå®¤2-4äººã€ä¸­å‹ä¼šè®®å®¤5-10äººã€å¤§å‹ä¼šè®®å…20-100äººã€è§†é¢‘ä¼šè®®å®¤ã€è‘£äº‹ä¼šä¼šè®®å®¤ï¼‰
3. ä¼šè®®å®¤è®¾å¤‡ç®¡ç†ï¼ˆæŠ•å½±ä»ªã€éŸ³å“ç³»ç»Ÿã€è§†é¢‘è®¾å¤‡ã€ç”µå­ç™½æ¿ã€èŒ¶æ°´æœåŠ¡ã€åŒä¼ è®¾å¤‡ç­‰ï¼‰
4. æ™ºèƒ½é¢„å®šç³»ç»Ÿï¼ˆæ—¶é—´å†²çªæ£€æµ‹ã€è‡ªåŠ¨æ¨èå¯ç”¨æ—¶æ®µã€å¾ªç¯é¢„å®šã€ä»£ç†é¢„å®šï¼‰
5. å¤šè§’è‰²æƒé™ç®¡ç†ï¼ˆæ™®é€šå‘˜å·¥ã€éƒ¨é—¨ä¸»ç®¡ã€åˆ†å…¬å¸ç®¡ç†å‘˜ã€é›†å›¢ç®¡ç†å‘˜ã€è¶…çº§ç®¡ç†å‘˜ï¼‰
6. çµæ´»çš„é¢„å®šå®¡æ‰¹æµç¨‹ï¼ˆæ ¹æ®ä¼šè®®å®¤çº§åˆ«ã€ä½¿ç”¨æ—¶é•¿ã€è·¨éƒ¨é—¨ä¼šè®®ç­‰è®¾ç½®ä¸åŒå®¡æ‰¹è§„åˆ™ï¼‰
7. å®æ—¶é€šçŸ¥ç³»ç»Ÿï¼ˆé‚®ä»¶ã€çŸ­ä¿¡ã€ä¼ä¸šå¾®ä¿¡ã€é’‰é’‰ã€é£ä¹¦ç­‰å¤šæ¸ é“ï¼‰
8. ä¼šè®®å®¤ä½¿ç”¨ç»Ÿè®¡å’Œåˆ†ææŠ¥å‘Šï¼ˆä½¿ç”¨ç‡ã€çƒ­é—¨æ—¶æ®µã€éƒ¨é—¨ä½¿ç”¨æƒ…å†µã€æˆæœ¬åˆ†æï¼‰
9. ç§»åŠ¨ç«¯APPæ”¯æŒæ‰«ç ç­¾åˆ°ã€æå‰/å»¶è¿Ÿç»“æŸä¼šè®®
10. ä¸ä¼ä¸šæ—¥å†ç³»ç»Ÿé›†æˆï¼ˆOutlookã€Google Calendarã€Exchangeç­‰ï¼‰
11. è®¿å®¢ç®¡ç†å’Œä¸´æ—¶é¢„å®šåŠŸèƒ½ï¼ˆè®¿å®¢é‚€è¯·ã€å®‰ä¿é€šçŸ¥ã€è®¿å®¢é€šè¡Œè¯æ‰“å°ï¼‰
12. æ™ºèƒ½ä¼šè®®å®¤æ¨èï¼ˆåŸºäºä¼šè®®è§„æ¨¡ã€è®¾å¤‡éœ€æ±‚ã€ä½ç½®åå¥½ã€å†å²åå¥½å­¦ä¹ ï¼‰
13. å–æ¶ˆå’Œå˜æ›´ç®¡ç†ï¼ˆè‡ªåŠ¨é‡Šæ”¾èµ„æºã€é€šçŸ¥ç›¸å…³äººå‘˜ã€å–æ¶ˆç½šåˆ†æœºåˆ¶ï¼‰
14. ä¼šè®®å®¤ç»´æŠ¤ç®¡ç†ï¼ˆæ¸…æ´æ—¶é—´ã€è®¾å¤‡æ£€ä¿®æ—¶é—´å±è”½ã€æ•…éšœæŠ¥ä¿®ï¼‰
15. èƒ½è€—ç›‘æ§å’Œç»¿è‰²åŠå…¬ï¼ˆä¼šè®®å®¤ç”¨ç”µç»Ÿè®¡ã€æ— äººè‡ªåŠ¨å…³é—­è®¾å¤‡ï¼‰
16. ä¼šè®®è®°å½•å’Œçºªè¦ç®¡ç†ï¼ˆä¼šè®®å½•éŸ³ã€ä¼šè®®çºªè¦ä¸Šä¼ ã€å‚ä¼šäººå‘˜ç¡®è®¤ï¼‰
ç³»ç»Ÿéœ€è¦æ”¯æŒé«˜å¹¶å‘è®¿é—®ï¼ˆå³°å€¼æ—¶æ®µå¯èƒ½åŒæ—¶æœ‰1000+ç”¨æˆ·é¢„å®šï¼‰ï¼Œå…·å¤‡è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒå’Œ7Ã—24å°æ—¶ç¨³å®šæ€§ã€‚"#
        ),
        (
            "åœºæ™¯4: ç®€å•ä»»åŠ¡",
            "è¯»å–é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ Cargo.toml æ–‡ä»¶å¹¶æ‰“å°å…¶ä¸­çš„ä¾èµ–åˆ—è¡¨"
        ),
    ];
    
    for (idx, (scenario_name, task_description)) in scenarios.iter().enumerate() {
        println!("\n{}", "=".repeat(80));
        println!("æ­£åœ¨æµ‹è¯•: {}", scenario_name);
        println!("{}", "=".repeat(80));
        
        // æ„å»ºprompt
        let prompt = PromptBuilder::new(template.clone())
            .build(task_description);
        
        println!("ğŸ“¤ å‘é€è¯·æ±‚åˆ°LongCat API...");
        
        // ç›´æ¥è°ƒç”¨æ¨¡å‹
        match model.complete(&prompt).await {
            Ok(response) => {
                println!("âœ… æ”¶åˆ°å“åº” ({} å­—ç¬¦)", response.content.len());
                
                // å†™å…¥åœºæ™¯ä¿¡æ¯
                writeln!(output_file, "\n## {}\n", scenario_name).unwrap();
                writeln!(output_file, "### ä»»åŠ¡æè¿°\n").unwrap();
                writeln!(output_file, "```").unwrap();
                writeln!(output_file, "{}", task_description.trim()).unwrap();
                writeln!(output_file, "```\n").unwrap();
                
                // å†™å…¥å®Œæ•´çš„åŸå§‹å“åº”
                writeln!(output_file, "### LongCatåŸå§‹å“åº”\n").unwrap();
                writeln!(output_file, "```").unwrap();
                writeln!(output_file, "{}", response.content).unwrap();
                writeln!(output_file, "```\n").unwrap();
                
                // å†™å…¥å“åº”ç»Ÿè®¡
                writeln!(output_file, "### å“åº”ç»Ÿè®¡\n").unwrap();
                writeln!(output_file, "- **å­—ç¬¦æ•°**: {}", response.content.len()).unwrap();
                writeln!(output_file, "- **è¡Œæ•°**: {}", response.content.lines().count()).unwrap();
                
                if let Some(usage) = &response.usage {
                    writeln!(output_file, "- **Prompt tokens**: {}", usage.prompt_tokens).unwrap();
                    writeln!(output_file, "- **Completion tokens**: {}", usage.completion_tokens).unwrap();
                    writeln!(output_file, "- **Total tokens**: {}", usage.total_tokens).unwrap();
                }
                
                writeln!(output_file, "\n---\n").unwrap();
            }
            Err(e) => {
                println!("âŒ è¯·æ±‚å¤±è´¥: {:?}", e);
                writeln!(output_file, "\n## {}\n", scenario_name).unwrap();
                writeln!(output_file, "**é”™è¯¯**: {:?}\n", e).unwrap();
                writeln!(output_file, "---\n").unwrap();
            }
        }
        
        // æš‚åœä»¥é¿å…APIé™æµ
        if idx < scenarios.len() - 1 {
            println!("â¸ï¸  æš‚åœ3ç§’ä»¥é¿å…é™æµ...");
            tokio::time::sleep(tokio::time::Duration::from_secs(3)).await;
        }
    }
    
    writeln!(output_file, "\n## æµ‹è¯•æ€»ç»“\n").unwrap();
    writeln!(output_file, "æ‰€æœ‰4ä¸ªæµ‹è¯•åœºæ™¯å·²å®Œæˆã€‚").unwrap();
    writeln!(output_file, "\n**ç”Ÿæˆæ—¶é—´**: 2025-10-13").unwrap();
    
    println!("\n{}", "=".repeat(80));
    println!("âœ… æ‰€æœ‰åŸå§‹å“åº”å·²ä¿å­˜åˆ° longcat_raw_responses.md");
    println!("{}", "=".repeat(80));
}
